<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with {{ twin_config.name }} - Digital Twin Platform</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" href="/static/images/favicon.ico" type="image/x-icon">
    <style>
        /* Timer display styles */
        .timer-container {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            position: relative;
            z-index: 100;
        }
        
        .timer-container.warning {
            background: linear-gradient(135deg, #ffa500, #ff8c00);
            animation: pulse 1.5s infinite;
        }
        
        .timer-container.critical {
            background: linear-gradient(135deg, #ff0000, #cc0000);
            animation: pulse 0.8s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        
        .timer-icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 1.2rem;
        }
        
        /* Expired overlay */
        .session-expired-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .session-expired-overlay.show {
            display: flex;
        }
        
        .expired-message {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .expired-message h2 {
            color: #ff6b6b;
            font-size: 2rem;
            margin-bottom: 20px;
        }
        
        .expired-message p {
            color: #666;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        .expired-message button {
            background: linear-gradient(135deg, #7F96B2, #B7DCED);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .expired-message button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Fixed configuration specific styles */
        .fixed-badge {
            background: #e74c3c;
            color: white;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            margin-top: 8px;
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .scenario-option:not(.active) {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .toggle-switch.disabled {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .toggle-switch.disabled .slider {
            cursor: not-allowed;
        }
        
        .control-label {
            color: #7F96B2 !important;
        }
    </style>
</head>
<body class="chat-page">
    <!-- Session expired overlay -->
    <div class="session-expired-overlay" id="expiredOverlay">
        <div class="expired-message">
            <h2>‚è∞ Session Expired</h2>
            <p>Your 10-minute chat session has ended. Click the button below to start a fresh conversation!</p>
            <button onclick="location.reload()">Start New Session</button>
        </div>
    </div>

    <div class="sidebar">
        <button class="back-button" onclick="window.location.href='/fixed'">
            ‚Üê Back to Fixed Configs
        </button>
        
        <!-- Timer Display -->
        <div class="timer-container" id="timerDisplay">
            <span class="timer-icon">‚è±Ô∏è</span>
            <span id="timerText">Time remaining: 10:00</span>
        </div>
        
        <div class="twin-profile">
            <div class="profile-avatar" id="profileAvatar">
                <!-- Avatar will be populated by JavaScript -->
            </div>
            <div class="profile-name" id="profileName">
                {{ twin_config.name }}
            </div>
            <div class="profile-details" id="profileDetails">
                {{ twin_config.age }} years old, Grade {{ twin_config.grade }}<br>
                Mental Health Type: {{ twin_config.mental_health_type|title }}
            </div>
        </div>

        <div class="controls-section">
            <div class="control-group">
                <label class="control-label">Scenario Environment (Fixed)</label>
                <div class="scenario-options">
                    <div class="scenario-option {% if fixed_config.scenario == 'neutral' %}active{% endif %}" data-scenario="neutral">
                        <div class="scenario-title">üå± Neutral Environment</div>
                        <div class="scenario-description-detailed">
                            <strong>Friendly halls</strong> with supportive classmates and light jokes.<br>
                            <strong>Group chats</strong> focus on homework, memes and weekend plans ‚Äî not on people.<br>
                            <strong>Teachers</strong> are fair and resolve small conflicts quickly.
                        </div>
                        {% if fixed_config.scenario == 'neutral' %}
                            <div class="fixed-badge">‚úì FIXED SETTING</div>
                        {% endif %}
                    </div>
                    <div class="scenario-option {% if fixed_config.scenario == 'toxic' %}active{% endif %}" data-scenario="toxic">
                        <div class="scenario-title">‚ö†Ô∏è Toxic Environment</div>
                        <div class="scenario-description-detailed">
                            <strong>Whispers, shoulder bumps and covert filming</strong> in hallways.<br>
                            <strong>Group chats</strong> share screenshots with mocking reactions or rumors.<br>
                            <strong>Bystanders stay silent</strong>, and adult help feels inconsistent.
                        </div>
                        {% if fixed_config.scenario == 'toxic' %}
                            <div class="fixed-badge">‚úì FIXED SETTING</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="control-group">
                <div class="rag-toggle-container">
                    <label class="control-label">
                        Enhanced Memory (RAG) - Fixed
                        <label class="toggle-switch disabled">
                            <input type="checkbox" id="ragToggle" {% if fixed_config.rag_enabled %}checked{% endif %} disabled>
                            <span class="slider"></span>
                        </label>
                    </label>
                    <div class="rag-description">
                        {% if fixed_config.rag_enabled %}
                            <strong>ENABLED:</strong> The AI is using additional context from video-based memories and past experiences to provide more realistic responses.
                        {% else %}
                            <strong>DISABLED:</strong> The AI is operating without enhanced memory context.
                        {% endif %}
                        <br><em>This setting is fixed for this conversation.</em>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Chat Controls</label>
                <div class="chat-controls">
                    <button class="control-button" onclick="clearChatFixed()" title="Clear chat history">
                        üóëÔ∏è Clear Chat
                    </button>
                    <button class="control-button" onclick="exportChatHistoryFixed()" title="Export chat history">
                        üíæ Export Chat
                    </button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label">Character Information</label>
                <div class="character-info">
                    <div id="characterStats">
                        <div class="character-stat">
                            <strong>Name:</strong> {{ twin_config.name }}
                        </div>
                        <div class="character-stat">
                            <strong>Age:</strong> {{ twin_config.age }} years
                        </div>
                        <div class="character-stat">
                            <strong>Grade:</strong> {{ twin_config.grade }}
                        </div>
                        <div class="character-stat">
                            <strong>Mental Health:</strong> {{ twin_config.mental_health_type|title }}
                        </div>
                        <div class="character-stat">
                            <strong>Environment:</strong> {% if fixed_config.scenario == 'neutral' %}Healthy{% else %}Toxic{% endif %}
                        </div>
                        <div class="character-stat">
                            <strong>Enhanced Memory:</strong> {% if fixed_config.rag_enabled %}Enabled{% else %}Disabled{% endif %}
                        </div>
                        <div class="character-stat" style="color: #ff6b6b; font-weight: bold;">
                            <strong>‚è±Ô∏è Session Limit:</strong> 10 minutes
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-title" id="chatTitle">Chat with {{ twin_config.name }}</div>
            <div class="chat-subtitle" id="chatSubtitle">
                {% if fixed_config.scenario == 'neutral' %}Healthy Environment{% else %}Toxic Environment{% endif %} ‚Ä¢ 
                Enhanced Memory: {% if fixed_config.rag_enabled %}ON{% else %}OFF{% endif %} (Fixed)
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be added dynamically -->
        </div>

        <div class="typing-indicator" id="typingIndicator">
            {{ twin_config.name }} is typing...
        </div>

        <div class="chat-input-container">
            <form class="chat-input-form" id="chatForm">
                <textarea 
                    class="chat-input" 
                    id="messageInput" 
                    placeholder="Type your message here..." 
                    rows="1"
                ></textarea>
                <button type="submit" class="send-button" id="sendButton">
                    ‚û§
                </button>
            </form>
        </div>
    </div>

    <script>
        // Fixed configuration data
        const FIXED_CONFIG = {
            twin_id: '{{ fixed_config.twin_id }}',
            scenario: '{{ fixed_config.scenario }}',
            rag_enabled: {{ 'true' if fixed_config.rag_enabled else 'false' }},
            config_key: '{{ config_key }}'
        };

        // Twin configuration for this specific twin
        const currentTwinConfig = {
            name: '{{ twin_config.name }}',
            age: {{ twin_config.age }},
            grade: '{{ twin_config.grade }}',
            avatar: '/static/images/{{ fixed_config.twin_id }}-avatar.png',
            description: '',
            mentalHealthType: '{{ twin_config.mental_health_type }}',
            ageGroup: 'late',
            initialMessage: "Hi! I'm {{ twin_config.name }}. How are you doing today?"
        };

        // Global variables
        let currentTwin = FIXED_CONFIG.twin_id;
        let currentScenario = FIXED_CONFIG.scenario;
        let ragEnabled = FIXED_CONFIG.rag_enabled;
        let isTyping = false;
        let chatHistory = [];
        
        // Timer variables
        let sessionStartTime = Date.now();
        let timerInterval = null;
        let sessionExpired = false;
        const SESSION_DURATION = 600; // 10 minutes in seconds

        // Timer functions
        function updateTimer() {
            if (sessionExpired) return;
            
            const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
            const remaining = Math.max(0, SESSION_DURATION - elapsed);
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;
            
            const timerText = document.getElementById('timerText');
            const timerDisplay = document.getElementById('timerDisplay');
            
            if (timerText) {
                timerText.textContent = `Time remaining: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // Change color based on remaining time
            if (timerDisplay) {
                if (remaining <= 60) {
                    timerDisplay.className = 'timer-container critical';
                } else if (remaining <= 180) {
                    timerDisplay.className = 'timer-container warning';
                } else {
                    timerDisplay.className = 'timer-container';
                }
            }
            
            // Handle session expiration
            if (remaining <= 0) {
                handleSessionExpired();
            }
        }
        
        function handleSessionExpired() {
            if (sessionExpired) return;
            
            sessionExpired = true;
            clearInterval(timerInterval);
            
            // Show expired overlay
            const overlay = document.getElementById('expiredOverlay');
            if (overlay) {
                overlay.classList.add('show');
            }
            
            // Disable input
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            if (messageInput) {
                messageInput.disabled = true;
                messageInput.placeholder = 'Session expired - please refresh to start new session';
            }
            if (sendButton) {
                sendButton.disabled = true;
            }
        }
        
        function startTimer() {
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeFixedChatPage();
            startTimer(); // Start the timer
        });

        function initializeFixedChatPage() {
            console.log('Initializing fixed chat page...');
            
            // Initialize twin profile
            initializeTwinProfileFixed();
            
            // Setup event listeners
            setupEventListenersFixed();
            
            // Add initial message after a short delay
            setTimeout(() => {
                addMessage('twin', currentTwinConfig.initialMessage);
            }, 500);
        }

        function initializeTwinProfileFixed() {
            const config = currentTwinConfig;
            
            // Update profile avatar
            const profileAvatar = document.getElementById('profileAvatar');
            if (profileAvatar) {
                profileAvatar.innerHTML = `<img src="${config.avatar}" alt="${config.name}" onerror="this.style.display='none'; this.parentNode.innerHTML='${config.name.charAt(0).toUpperCase()}';">`;
            }
        }

        function setupEventListenersFixed() {
            // Message form submission
            const chatForm = document.getElementById('chatForm');
            if (chatForm) {
                chatForm.addEventListener('submit', sendMessageFixed);
            }
            
            // Auto-resize textarea
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('input', autoResizeTextarea);
                messageInput.addEventListener('keydown', handleKeyDown);
            }
        }

        function sendMessageFixed(event) {
            event.preventDefault();
            
            if (sessionExpired) {
                alert('Your session has expired. Please refresh the page to start a new conversation.');
                return;
            }
            
            const messageInput = document.getElementById('messageInput');
            if (!messageInput) return;
            
            const message = messageInput.value.trim();
            
            if (!message || isTyping) return;
            
            console.log('Sending message:', message);
            
            // Add user message to chat
            addMessage('user', message);
            
            // Clear input
            messageInput.value = '';
            autoResizeTextarea({ target: messageInput });
            
            // Show typing indicator
            showTypingIndicator();
            
            // Send message to backend using fixed API
            fetch('/api/send_message_fixed', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    config_key: FIXED_CONFIG.config_key
                })
            })
            .then(response => {
                if (response.status === 403) {
                    return response.json().then(data => {
                        throw new Error('session_expired');
                    });
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                hideTypingIndicator();
                if (data.response) {
                    addMessage('twin', data.response);
                }
                
                // Update timer with server's remaining time if provided
                if (data.remaining_seconds !== undefined) {
                    const elapsed = SESSION_DURATION - data.remaining_seconds;
                    sessionStartTime = Date.now() - (elapsed * 1000);
                }
            })
            .catch(error => {
                hideTypingIndicator();
                
                if (error.message === 'session_expired') {
                    handleSessionExpired();
                } else {
                    console.error('Error sending message:', error);
                    addMessage('twin', 'Sorry, I had trouble understanding that. Could you try again?');
                    showNotification('Failed to send message', 'error');
                }
            });
        }

        function addMessage(sender, content, timestamp = new Date()) {
            const messagesContainer = document.getElementById('chatMessages');
            if (!messagesContainer) return;
            
            const config = currentTwinConfig;
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // Process emotion tags just like in original
            let processedContent = content;
            if (sender === 'twin' || sender === 'assistant') {
                const emotionTagRegex = /(.*?)[\s\n]*(Emotion(?:al)?\s*tag\s*:\s*[^\n]+)$/i;
                const match = processedContent.match(emotionTagRegex);
                
                if (match) {
                    const mainContent = match[1].trim();
                    const emotionTag = match[2];
                    processedContent = `${mainContent}<div class="emotion-tag-separator">${emotionTag}</div>`;
                }
            }
            
            // Determine avatar content
            let avatarContent;
            if (sender === 'user') {
                avatarContent = 'üë§';
            } else if (sender === 'system') {
                avatarContent = '‚öôÔ∏è';
            } else {
                avatarContent = `<img src="${config.avatar}" alt="${config.name}" onerror="this.style.display='none'; this.parentNode.innerHTML='${config.name.charAt(0).toUpperCase()}';">`;
            }
            
            // Convert line breaks to HTML
            const formattedContent = processedContent.replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarContent}</div>
                <div class="message-content">
                    ${formattedContent}
                    <div class="message-time" style="font-size: 0.7rem; opacity: 0.6; margin-top: 5px;">
                        ${formatTime(timestamp)}
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            
            // Add to chat history
            chatHistory.push({
                sender: sender,
                content: content,
                timestamp: timestamp
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Add animation
            setTimeout(() => {
                messageDiv.style.opacity = '1';
            }, 50);
        }

        function showTypingIndicator() {
            isTyping = true;
            const typingIndicator = document.getElementById('typingIndicator');
            const sendButton = document.getElementById('sendButton');
            
            if (typingIndicator) {
                typingIndicator.textContent = `${currentTwinConfig.name} is typing...`;
                typingIndicator.style.display = 'block';
            }
            
            if (sendButton) {
                sendButton.disabled = true;
                sendButton.classList.add('loading');
            }
            
            const messagesContainer = document.getElementById('chatMessages');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function hideTypingIndicator() {
            isTyping = false;
            const typingIndicator = document.getElementById('typingIndicator');
            const sendButton = document.getElementById('sendButton');
            
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
            
            if (sendButton) {
                sendButton.disabled = false;
                sendButton.classList.remove('loading');
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessageFixed(event);
            }
        }

        function autoResizeTextarea(event) {
            const textarea = event.target;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function formatTime(date = new Date()) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#e74c3c' : '#7F96B2'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Chat utilities
        function clearChatFixed() {
            const messagesContainer = document.getElementById('chatMessages');
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
            }
            chatHistory = [];
            setTimeout(() => {
                addMessage('twin', currentTwinConfig.initialMessage);
            }, 500);
        }

        function exportChatHistoryFixed() {
            const config = currentTwinConfig;
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `chat_${config.name}_fixed_${timestamp}.json`;
            
            const data = {
                twin: config,
                fixed_config: FIXED_CONFIG,
                scenario: currentScenario,
                rag_enabled: ragEnabled,
                messages: chatHistory,
                exported_at: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Chat history exported');
        }

        // Warn before leaving page
        window.addEventListener('beforeunload', function(e) {
            if (!sessionExpired && chatHistory.length > 1) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
